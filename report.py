# coding=utf-8
from pylatex import Document, Section, Subsection, Command, LongTable
from pylatex.utils import NoEscape
import os
import json
import re

def getFromSquareBrackets(s):
    return re.findall("\[(.*?)\]", s)

def fill_document(doc):

    # import required module

    # Directorio en el que se encuentran todos los JSON 
    directory = '.\\resultados'
    diff_files = []
    virus_files = []


    # iterate over files in directory

    for filename in os.listdir(directory):
        f = os.path.join(directory, filename)
        # checking if it is a file

        if os.path.isfile(f):
            if filename.startswith("virustotal"):
                virus_files.append(f)
            else:
                diff_files.append(f)



    with doc.create(Section("Permissions")):
             for f in diff_files:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                print(data)
                if data == {}: continue;
                if "dictionary_item_added" in data:
                    print(data["dictionary_item_added"])
                with doc.create(Subsection(f)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            if "dictionary_item_added" in data:
                                for value in data["dictionary_item_added"]:
                                    row = getFromSquareBrackets(value.replace('root',''))[1]
                                    data_table.add_row([row])

    with doc.create(Section("Antivirus Scan")):

             for f in virus_files:
                    file = open(f)
                    data = json.load(file)
                    print(data)
                    if data == {}: continue;
                    if data["positives"] != 0:
                            with doc.create(Subsection(f)):
               
                                # Generate data table
                                with doc.create(LongTable("l l")) as data_table:
                                        data_table.add_hline()
                                        data_table.add_row(["Antivirus", "Virus founds"])
                                        data_table.add_hline()
                                        data_table.end_table_header()
                                        data_table.add_hline()
                                        data_table.end_table_last_footer()
                                        for key,value in data["scans"].items():
                                            if value["result"] is not None:
                                                row = [key, value["result"]]
                                                data_table.add_row(row)




if __name__ == '__main__':
    geometry_options = {
        "margin": "2cm",
        "includeheadfoot": True
    }
    # Basic document
    doc = Document('report', geometry_options=geometry_options)

    # Document with `\maketitle` command activated

    doc.preamble.append(Command('title', 'Malware Analysis'))
    doc.preamble.append(Command('date', NoEscape(r'\today')))
    doc.append(NoEscape(r'\maketitle'))

    fill_document(doc)

    doc.generate_pdf('report_generated', clean_tex=False)



