from pylatex import Document, Section, Subsection, Command, LongTable,MultiColumn
from pylatex.utils import italic, NoEscape
import os
import json
from deepdiff import extract
import re

def getFromSquareBrackets(s):
    return re.findall("\[(.*?)\]", s)

def fill_document(doc):

    # import required module

    # assign directory
    directory = '.\\results_entretenimiento'
    diff_files_disney = []
    virus_files_disney = []
    diff_files_amazon = []
    virus_files_amazon = []
    diff_files_youtube = []
    virus_files_youtube = []
    diff_files_netflix = []
    virus_files_netflix = []
    # iterate over files in
    # that directory
    with doc.create(Section('Differences found ')):
        doc.append('Differences between original app and mod. ')

    for filename in os.listdir(directory):
        f = os.path.join(directory, filename)
        # checking if it is a file

        if os.path.isfile(f):
           if "disney" in filename:
               if filename.startswith("diff"):
                    diff_files_disney.append(f)
               elif filename.startswith("virustotal"):
                   virus_files_disney.append(f)
           if "amazon" in filename:
               if filename.startswith("diff"):
                    diff_files_amazon.append(f)
               elif filename.startswith("virustotal"):
                   virus_files_amazon.append(f)
           if "youtube" in filename:
               if filename.startswith("diff"):
                    diff_files_youtube.append(f)
               elif filename.startswith("virustotal"):
                   virus_files_youtube.append(f)
           if "netflix" in filename:
               if filename.startswith("diff"):
                    diff_files_netflix.append(f)
               elif filename.startswith("virustotal"):
                   virus_files_netflix.append(f)


    with doc.create(Section('Disney Plus')):
             for f in diff_files_disney:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                #print(data)
                if data == {}: continue;
                print(data["dictionary_item_added"])
                with doc.create(Subsection(f)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            for value in data["dictionary_item_added"]:
                                row = getFromSquareBrackets(value.replace('root',''))[1]
                                data_table.add_row([row])
             for f in virus_files_disney:
                    file = open(f)
                    data = json.load(file)
                    #print(data)
                    if data == {}: continue;
                    if data["positives"] != 0:
                            with doc.create(Subsection(f)):
               
                                # Generate data table
                                with doc.create(LongTable("l l")) as data_table:
                                        data_table.add_hline()
                                        data_table.add_row(["Antivirus", "Virus founds"])
                                        data_table.add_hline()
                                        data_table.end_table_header()
                                        data_table.add_hline()
                                        data_table.end_table_last_footer()
                                        for key,value in data["scans"].items():
                                            if value["result"] is not None:
                                                row = [key, value["result"]]
                                                data_table.add_row(row)


    with doc.create(Section('Amazon Prime Video')):
             for f in diff_files_amazon:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                #print(data)
                if data == {}: continue;
                print(data["dictionary_item_added"])
                with doc.create(Subsection(f)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            for value in data["dictionary_item_added"]:
                                row = getFromSquareBrackets(value.replace('root',''))[1]
                                data_table.add_row([row])

             for f in virus_files_amazon:
                    file = open(f)
                    data = json.load(file)
                    #print(data)
                    if data == {}: continue;
                    if data["positives"] != 0:
                            with doc.create(Subsection(f)):
               
                                # Generate data table
                                with doc.create(LongTable("l l")) as data_table:
                                        data_table.add_hline()
                                        data_table.add_row(["Antivirus", "Virus founds"])
                                        data_table.add_hline()
                                        data_table.end_table_header()
                                        data_table.add_hline()
                                        data_table.end_table_last_footer()
                                        for key,value in data["scans"].items():
                                            if value["result"] is not None:
                                                row = [key, value["result"]]
                                                data_table.add_row(row)

    with doc.create(Section('Youtube')):
             for f in diff_files_youtube:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                #print(data)
                if data == {}: continue;
                print(data["dictionary_item_added"])
                with doc.create(Subsection(f)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            for value in data["dictionary_item_added"]:
                                row = getFromSquareBrackets(value.replace('root',''))[1]
                                data_table.add_row([row])
             for f in virus_files_youtube:
                    file = open(f)
                    data = json.load(file)
                    #print(data)
                    if data == {}: continue;
                    if data["positives"] != 0:
                            with doc.create(Subsection(f)):
               
                                # Generate data table
                                with doc.create(LongTable("l l")) as data_table:
                                        data_table.add_hline()
                                        data_table.add_row(["Antivirus", "Virus founds"])
                                        data_table.add_hline()
                                        data_table.end_table_header()
                                        data_table.add_hline()
                                        data_table.end_table_last_footer()
                                        for key,value in data["scans"].items():
                                            if value["result"] is not None:
                                                row = [key, value["result"]]
                                                data_table.add_row(row)
    with doc.create(Section('Netflix')):
             for f in diff_files_netflix:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                #print(data)
                if data == {}: continue;
                print(data["dictionary_item_added"])
                with doc.create(Subsection(f)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            for value in data["dictionary_item_added"]:
                                row = getFromSquareBrackets(value.replace('root',''))[1]
                                data_table.add_row([row])
             for f in virus_files_netflix:
                    file = open(f)
                    data = json.load(file)
                    #print(data)
                    if data == {}: continue;
                    if data["positives"] != 0:
                            with doc.create(Subsection(f)):
               
                                # Generate data table
                                with doc.create(LongTable("l l")) as data_table:
                                        data_table.add_hline()
                                        data_table.add_row(["Antivirus", "Virus founds"])
                                        data_table.add_hline()
                                        data_table.end_table_header()
                                        data_table.add_hline()
                                        data_table.end_table_last_footer()
                                        for key,value in data["scans"].items():
                                            if value["result"] is not None:
                                                row = [key, value["result"]]
                                                data_table.add_row(row)
"""
        for f in diff_files:
                file = open(f)

                data = json.load(file)
                data = json.loads(data)
                #print(data)
                if data == {}: continue;
                print(data["dictionary_item_added"])
                with doc.create(Subsection(filename)):
               
                    # Generate data table
                    with doc.create(LongTable("l")) as data_table:
                            data_table.add_hline()
                            data_table.add_row(["Added Permissions"])
                            data_table.add_hline()
                            data_table.end_table_header()
                            data_table.add_hline()
                            data_table.end_table_last_footer()
                            for value in data["dictionary_item_added"]:
                                row = getFromSquareBrackets(value.replace('root',''))[1]
                                data_table.add_row([row])
        for f in virus_files:
                file = open(f)
                data = json.load(file)
                #print(data)
                if data == {}: continue;
                if data["positives"] != 0:
                        with doc.create(Subsection(filename)):
               
                            # Generate data table
                            with doc.create(LongTable("l l")) as data_table:
                                    data_table.add_hline()
                                    data_table.add_row(["Antivirus", "Virus founds"])
                                    data_table.add_hline()
                                    data_table.end_table_header()
                                    data_table.add_hline()
                                    data_table.end_table_last_footer()
                                    for key,value in data["scans"].items():
                                        if value["result"] is not None:
                                            row = [key, value["result"]]
                                            data_table.add_row(row)

"""


if __name__ == '__main__':
    geometry_options = {
        "margin": "2cm",
        "includeheadfoot": True
    }

    doc = Document('report', geometry_options=geometry_options)

    doc.preamble.append(Command('title', 'Malware Analysis'))
    doc.preamble.append(Command('date', NoEscape(r'\today')))
    doc.append(NoEscape(r'\maketitle'))

    fill_document(doc)

    doc.generate_pdf('report', clean_tex=False)

